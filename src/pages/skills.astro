---
import Layout from "../layouts/Layout.astro";
import { getEntry } from 'astro:content';

// 1. Fetch Material
const entry = await getEntry('skills', 'skills');
const rawContent = entry?.body || '';

// 2. Category Parser
const parseSkills = (text: string) => {
    const sections = text.trim().split(/^#\s+/m).filter(Boolean);
    return sections.map(section => {
        const lines = section.split('\n').filter(l => l.trim());
        const header = lines.shift() || 'UNKNOWN_MODULE';
        const skills = lines.map(line => {
            const match = line.match(/^-\s*(\*?)(.*?):\s*(.*)$/);
            if (!match) return null;
            return {
                isStarred: match[1] === '*',
                name: match[2].trim(),
                duration: match[3].trim()
            };
        }).filter((skill): skill is { isStarred: boolean; name: string; duration: string } => skill !== null);
        return { header, skills };
    });
};

const modules = parseSkills(rawContent);

// 3. Normalization & Logarithmic Math
// Convert all durations to months to create a dataset
const allSkillsFlat = modules.flatMap(m => m.skills).map(s => {
    const amount = parseInt(s.duration.split(' ')[0]) || 0;
    const isYear = s.duration.toLowerCase().includes('year');
    return { ...s, totalMonths: isYear ? amount * 12 : amount };
});

const monthValues = allSkillsFlat.map(s => s.totalMonths);
const minMonths = Math.min(...monthValues);
const maxMonths = Math.max(...monthValues);

/**
 * Normalizes value using Logarithmic scaling to prevent 
 * long-term legacy skills from washing out newer ones.
 */
const getActiveSegments = (months: number) => {
    const totalSegments = 12;
    if (maxMonths === minMonths) return totalSegments;

    // Logarithmic scale: log(val) / log(max)
    // We add 1 to avoid log(0) and log(1) issues
    const logMax = Math.log(maxMonths + 1);
    const logMin = Math.log(minMonths + 1);
    const logVal = Math.log(months + 1);

    const normalized = (logVal - logMin) / (logMax - logMin);
    return Math.max(1, Math.round(normalized * totalSegments));
};

/**
 * Gets the color class for a segment based on its index and active segments.
 * Avoids <= operators in JSX to prevent parser conflicts.
 */
const getSegmentColorClass = (segmentIndex: number, activeSegments: number) => {
    const totalSegments = 12;
    const fraction = totalSegments / 8;
    
    // Check if segment is active
    if (segmentIndex > activeSegments) {
        return "bg-slate-800/40"; // Inactive
    }
    
    // Determine color based on tier
    if (segmentIndex > fraction * 2) {
        return "bg-emerald-500 shadow-[0_0_8px_#10b981] animate-pulse"; // High/Master
    } else if (segmentIndex > fraction) {
        return "bg-yellow-500 shadow-[0_0_8px_#ecc94b] animate-pulse"; // Mid/Familiar
    } else {
        return "bg-orange-600 shadow-[0_0_8px_#dd6b20] animate-pulse"; // Low/Early
    }
};
---

<Layout title="System Skills">
    <div class="max-w-6xl mx-auto py-10 px-4">
        <!-- Header with Interactive Filters -->
        <div class="mb-12 border-b border-emerald-500/20 pb-6">
            <h1 class="text-3xl font-bold tracking-tighter text-slate-800 dark:text-slate-100 uppercase">
                <span class="text-emerald-500 font-medium font-mono mr-2">[0x00]</span> 
                <span class="font-mono font-medium">SKILLS_MANIFEST</span>
            </h1>
            <p class="font-mono text-[10px] text-slate-500 mt-2 uppercase tracking-widest">
                Status: <span id="system-status" class="text-emerald-400">Online</span> | 
                Modules_Detected: <span id="modules-count">{modules.length}</span> | 
                Skills_Total: <span id="skills-count">{allSkillsFlat.length}</span>
            </p>
        </div>

        <!-- Interactive Filter Buttons -->
        <div class="mb-8 flex flex-wrap gap-3">
            <button 
                id="filter-all" 
                class="filter-btn active px-4 py-2 font-mono text-xs border border-emerald-500 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 transition-all rounded uppercase tracking-wider"
                data-filter="all"
            >
                [SHOW_ALL]
            </button>
            <button 
                id="filter-starred" 
                class="filter-btn px-4 py-2 font-mono text-xs border border-slate-300 dark:border-slate-700 bg-slate-200 dark:bg-slate-900/50 text-slate-700 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all rounded uppercase tracking-wider"
                data-filter="starred"
            >
                [&#9733;_STARRED]
            </button>
            <button 
                id="filter-expand" 
                class="filter-btn px-4 py-2 font-mono text-xs border border-slate-300 dark:border-slate-700 bg-slate-200 dark:bg-slate-900/50 text-slate-700 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all rounded uppercase tracking-wider"
                data-filter="expand"
            >
                [&#9660;_EXPAND_ALL]
            </button>
            <button 
                id="filter-collapse" 
                class="filter-btn px-4 py-2 font-mono text-xs border border-slate-300 dark:border-slate-700 bg-slate-200 dark:bg-slate-900/50 text-slate-700 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all rounded uppercase tracking-wider"
                data-filter="collapse"
            >
                [&#9650;_COLLAPSE_ALL]
            </button>
        </div>

        <!-- Skills Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
            {modules.map((module, moduleIndex) => (
                <section 
                    class="skill-module relative border border-slate-300 dark:border-slate-800 bg-white/95 dark:bg-slate-900/50 backdrop-blur-sm rounded-lg overflow-hidden transition-all duration-500 hover:border-emerald-500/50 shadow-md shadow-slate-200/60 dark:shadow-none hover:shadow-[0_0_30px_rgba(16,185,129,0.1)]"
                    data-module={module.header}
                    style={`animation-delay: ${moduleIndex * 0.1}s`}
                >
                    {/* Decorative Elements */}
                    <div class="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-emerald-500/30"></div>
                    <div class="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-emerald-500/30"></div>
                    <div class="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-emerald-500/30"></div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-emerald-500/30"></div>
                
                    {/* Clickable Header */}
                    <header 
                        class="module-header flex justify-between items-center p-6 pb-4 cursor-pointer group/header hover:bg-emerald-500/5 transition-all"
                        data-collapsed="false"
                    >
                        <div class="flex items-center gap-3">
                            <span class="collapse-indicator text-emerald-600 dark:text-emerald-500 font-mono text-sm transition-transform duration-300">&#9660;</span>
                            <h2 class="font-mono text-sm font-bold text-emerald-600 dark:text-emerald-400 tracking-widest uppercase group-hover/header:text-emerald-500 dark:group-hover/header:text-emerald-300 transition-colors">
                                {module.header}
                            </h2>
                            <span class="module-count font-mono text-[10px] text-slate-700 dark:text-slate-600 bg-slate-200 dark:bg-slate-800/50 px-2 py-0.5 rounded">
                                {module.skills.length}
                            </span>
                        </div>
                        <div class="flex gap-1.5 items-center">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_8px_#10b981]"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-700 group-hover/header:bg-slate-600 transition-colors"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-700 group-hover/header:bg-slate-600 transition-colors"></div>
                        </div>
                    </header>

                    {/* Skills Content */}
                    <div class="module-content p-6 pt-2 space-y-4 transition-all duration-300">
                        {module.skills.map((skill) => {
                            const amount = parseInt(skill.duration.split(' ')[0]) || 0;
                            const isYear = skill.duration.toLowerCase().includes('year');
                            const months = isYear ? amount * 12 : amount;
                            const activeSegments = getActiveSegments(months);
                            const totalSegments = 12;

                            return (
                                <div 
                                    class={`skill-item group/skill p-4 border-l-2 transition-all duration-300 cursor-pointer rounded-r hover:translate-x-1 ${
                                        skill.isStarred 
                                            ? 'border-emerald-500 bg-emerald-500/5 hover:bg-emerald-500/10' 
                                            : 'border-slate-300 dark:border-slate-700 hover:border-emerald-500/50 hover:bg-slate-100 dark:hover:bg-slate-800/30'
                                    }`}
                                    data-starred={skill.isStarred}
                                >
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center gap-2">
                                            {skill.isStarred && (
                                                <span class="text-emerald-500 text-sm animate-pulse">&#9733;</span>
                                            )}
                                            <span class={`font-mono text-sm tracking-tight transition-colors ${
                                                skill.isStarred 
                                                    ? 'text-emerald-700 dark:text-emerald-300 font-bold' 
                                                    : 'text-slate-700 dark:text-slate-300 group-hover/skill:text-emerald-600 dark:group-hover/skill:text-emerald-400'
                                            }`}>
                                                {skill.name}
                                            </span>
                                        </div>
                                        <span class="font-mono text-[10px] text-slate-600 dark:text-slate-500 uppercase tracking-wider bg-slate-200 dark:bg-slate-900/50 px-2 py-1 rounded">
                                            {skill.duration}
                                        </span>
                                    </div>

                                    {/* Interactive Progress Bar */}
                                    <div class="flex gap-1 h-2 mt-2 group/gauge">
                                        {[...Array(totalSegments)].map((_, i) => {
                                            const segmentIndex = i + 1;
                                            const colorClass = getSegmentColorClass(segmentIndex, activeSegments);

                                            return (
                                                <div 
                                                    class={`skill-segment flex-1 rounded-sm transition-all duration-500 hover:scale-y-150 hover:h-3 ${colorClass}`}
                                                    data-segment={segmentIndex}
                                                />
                                            );
                                        })}
                                    </div>

                                    {/* Proficiency Label (Hidden by default, shown on hover) */}
                                    <div class="proficiency-label mt-2 opacity-0 group-hover/skill:opacity-100 transition-opacity duration-300">
                                        <span class="font-mono text-[9px] text-slate-500 dark:text-slate-600 uppercase">
                                            Proficiency: <span class="text-emerald-600 dark:text-emerald-500">{Math.round((activeSegments / totalSegments) * 100)}%</span>
                                        </span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </section>
            ))}
        </div>

        <!-- Stats Footer -->
        <div class="mt-16 pt-10 border-t border-slate-300 dark:border-slate-800/50">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card text-center p-6 bg-white dark:bg-slate-900/40 rounded-lg border border-slate-300 dark:border-slate-800 hover:border-emerald-500/30 transition-all cursor-pointer group shadow-sm shadow-slate-200/60 dark:shadow-none">
                    <div class="font-mono text-2xl font-bold text-emerald-500 mb-2 group-hover:scale-110 transition-transform">
                        {modules.length}
                    </div>
                    <div class="font-mono text-[10px] text-slate-600 dark:text-slate-500 uppercase tracking-widest">Categories</div>
                </div>
                <div class="stat-card text-center p-6 bg-white dark:bg-slate-900/40 rounded-lg border border-slate-300 dark:border-slate-800 hover:border-emerald-500/30 transition-all cursor-pointer group shadow-sm shadow-slate-200/60 dark:shadow-none">
                    <div class="font-mono text-2xl font-bold text-emerald-600 dark:text-emerald-500 mb-2 group-hover:scale-110 transition-transform">
                        {allSkillsFlat.length}
                    </div>
                    <div class="font-mono text-[10px] text-slate-600 dark:text-slate-500 uppercase tracking-widest">Total Skills</div>
                </div>
                <div class="stat-card text-center p-6 bg-white dark:bg-slate-900/40 rounded-lg border border-slate-300 dark:border-slate-800 hover:border-emerald-500/30 transition-all cursor-pointer group shadow-sm shadow-slate-200/60 dark:shadow-none">
                    <div class="font-mono text-2xl font-bold text-emerald-600 dark:text-emerald-500 mb-2 group-hover:scale-110 transition-transform">
                        {allSkillsFlat.filter(s => s.isStarred).length}
                    </div>
                    <div class="font-mono text-[10px] text-slate-600 dark:text-slate-500 uppercase tracking-widest">Starred</div>
                </div>
                <div class="stat-card text-center p-6 bg-white dark:bg-slate-900/40 rounded-lg border border-slate-300 dark:border-slate-800 hover:border-emerald-500/30 transition-all cursor-pointer group shadow-sm shadow-slate-200/60 dark:shadow-none">
                    <div class="font-mono text-2xl font-bold text-emerald-600 dark:text-emerald-500 mb-2 group-hover:scale-110 transition-transform">
                        {Math.round(maxMonths / 12)}+
                    </div>
                    <div class="font-mono text-[10px] text-slate-600 dark:text-slate-500 uppercase tracking-widest">Years (Max)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Filter functionality
        const filterButtons = document.querySelectorAll('.filter-btn');
        const skillItems = document.querySelectorAll('.skill-item');
        const modules = document.querySelectorAll('.skill-module');
        const moduleHeaders = document.querySelectorAll('.module-header');

        // Filter button clicks
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = (btn as HTMLElement).dataset.filter;
                
                if (filter === 'all') {
                    skillItems.forEach(item => {
                        (item as HTMLElement).style.display = 'block';
                    });
                    updateActiveButton(btn as HTMLElement);
                } else if (filter === 'starred') {
                    skillItems.forEach(item => {
                        if ((item as HTMLElement).dataset.starred === 'true') {
                            (item as HTMLElement).style.display = 'block';
                        } else {
                            (item as HTMLElement).style.display = 'none';
                        }
                    });
                    updateActiveButton(btn as HTMLElement);
                } else if (filter === 'expand') {
                    moduleHeaders.forEach(header => {
                        const content = header.nextElementSibling as HTMLElement;
                        const indicator = header.querySelector('.collapse-indicator') as HTMLElement;
                        const headerElement = header as HTMLElement;
                        if(content){
                            content.style.display = 'block';
                        }
                        setTimeout(() => {
                            content.classList.remove('collapsed');
                            indicator.style.transform = 'rotate(0deg)';
                        }, 10);
                        headerElement.dataset.collapsed = 'false';
                    });
                } else if (filter === 'collapse') {
                    moduleHeaders.forEach(header => {
                        const content = header.nextElementSibling as HTMLElement;
                        const indicator = header.querySelector('.collapse-indicator') as HTMLElement;
                        const headerElement = header as HTMLElement;
                        content.classList.add('collapsed');
                        indicator.style.transform = 'rotate(-90deg)';
                        headerElement.dataset.collapsed = 'true';
                        setTimeout(() => {
                            if (headerElement.dataset.collapsed === 'true') {
                                content.style.display = 'none';
                            }
                        }, 300);
                    });
                }
            });
        });

        function updateActiveButton(activeBtn: HTMLElement) {
            filterButtons.forEach(btn => {
                if ((btn as HTMLElement).dataset.filter === 'expand' || (btn as HTMLElement).dataset.filter === 'collapse') return;
                
                if (btn === activeBtn) {
                    btn.classList.add('active', 'border-emerald-500', 'bg-emerald-500/10', 'text-emerald-400');
                    btn.classList.remove('border-slate-300', 'dark:border-slate-700', 'bg-slate-200', 'dark:bg-slate-900/50', 'text-slate-700', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('active', 'border-emerald-500', 'bg-emerald-500/10', 'text-emerald-400');
                    btn.classList.add('border-slate-300', 'dark:border-slate-700', 'bg-slate-200', 'dark:bg-slate-900/50', 'text-slate-700', 'dark:text-slate-400');
                }
            });
        }

        // Module collapse/expand on header click
        moduleHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling as HTMLElement;
                const indicator = header.querySelector('.collapse-indicator') as HTMLElement;
                const headerElement = header as HTMLElement;
                const isCollapsed = headerElement.dataset.collapsed === 'true';

                if (isCollapsed) {
                    content.style.display = 'block';
                    // Use setTimeout to allow display change to take effect
                    setTimeout(() => {
                        content.classList.remove('collapsed');
                        indicator.style.transform = 'rotate(0deg)';
                    }, 10);
                    (header as HTMLElement).dataset.collapsed = 'false';
                } else {
                    content.classList.add('collapsed');
                    indicator.style.transform = 'rotate(-90deg)';
                    headerElement.dataset.collapsed = 'true';
                    // Wait for transition before hiding
                    setTimeout(() => {
                        if (headerElement.dataset.collapsed === 'true') {
                            content.style.display = 'none';
                        }
                    }, 300);
                }
            });
        });

        // Skill item click feedback
        skillItems.forEach(item => {
            item.addEventListener('click', () => {
                // Add ripple effect
                (item as HTMLElement).style.transform = 'scale(0.98)';
                setTimeout(() => {
                    (item as HTMLElement).style.transform = 'scale(1)';
                }, 100);
            });
        });

        // Stat cards click animation
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('click', () => {
                (card as HTMLElement).style.transform = 'scale(0.95)';
                setTimeout(() => {
                    (card as HTMLElement).style.transform = 'scale(1)';
                }, 150);
            });
        });
    </script>

    <style>
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .skill-module {
            animation: slideInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .module-content {
            max-height: 100vh;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
        }

        .skill-segment {
            cursor: pointer;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }

        .filter-btn:active {
            transform: translateY(0);
        }
    </style>
</Layout>