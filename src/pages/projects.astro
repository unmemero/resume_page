---
import Layout from "../layouts/Layout.astro";
import { getEntry } from 'astro:content';
import { marked } from 'marked';

const entry = await getEntry('projects', 'projects');
const { projects } = entry?.data;

const projectDocs = await entry?.body.split(/^#+\s+/m).filter(Boolean).reduce(async (accPromise, section)=> {
    const acc = await accPromise;
    const lines = section.split('\n') || [];
    const id = lines.shift()?.trim();
    if(id){
        const content = lines.join('\n');
        // Split by dash and filter out empty items
        const items = content.split('-').map(item => item.trim()).filter(Boolean);
        acc[id] = await Promise.all(items.map(item => marked.parseInline(item)));
    }
    return acc;
}, Promise.resolve({} as Record<string, string[]>));
---

<Layout title="Projects">
    <div class="max-w-6xl mx-auto py-12 px-4">
        <div class="relative mb-8 pb-6 border-b border-emerald-500/20">
            <h1 class="text-4xl font-bold tracking-tight text-slate-100 uppercase">
                <span class="text-emerald-500 font-mono font-medium mr-2">[0x03]</span>
                <span class="font-mono font-medium">Projects_dir</span>
            </h1>
            <p class="font-mono text-[10px] text-slate-500 mt-3 uppercase tracking-widest">
                Status: <span class="text-yellow-600">IN_PROGRESS</span> | 
                Repositories: <span class="text-emerald-400">{projects.length}</span> | 
                Mode: <span class="text-emerald-400">Nuclear</span>
            </p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-0 border border-slate-300 dark:border-slate-800 bg-white/95 dark:bg-slate-900/40 rounded-lg overflow-hidden shadow-md shadow-slate-200/60 dark:shadow-xl">
            <div class="lg:col-span-3 border-r border-slate-300 dark:border-slate-800 bg-slate-50 dark:bg-black/50 p-4">
                <div class="mb-4 pb-3 border-b border-slate-300 dark:border-slate-800">
                    <span class="text-[10px] font-mono text-emerald-600 dark:text-emerald-400 uppercase tracking-wider">&#9889; Project Explorer</span>
                    <div class="text-[8px] text-slate-500 dark:text-slate-600 mt-1">{projects.length} repositories loaded</div>
                </div>
                <nav class="space-y-1">
                    {projects.map((p: any, idx: number)=>(
                        <button
                            class="project-tab w-full flex items-center gap-2 px-3 py-2 text-xs font-mono text-slate-600 dark:text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-400 transition-all duration-200 group rounded-md relative overflow-hidden"
                            data-target={p.id}
                        >
                            <span class="absolute inset-0 bg-emerald-500/0 group-hover:bg-emerald-500/10 transition-colors duration-200"></span>
                            <span class="text-emerald-700 dark:text-emerald-900 group-hover:text-emerald-500 transition-colors z-10">&#128196;</span> 
                            <span class="z-10 flex-1 text-left">{p.title}.git</span>
                            <span class="ml-auto text-[8px] text-slate-500 dark:text-slate-600 group-hover:text-emerald-600 z-10">#{idx.toString().padStart(2, '0')}</span>
                        </button>
                    ))}
                </nav>
            </div>

            <div class="lg:col-span-9 p-6 md:p-12 min-h-100 relative bg-white dark:bg-slate-900/30">
            {projects.map((p:any, i:any) => (
                <div
                    id={`content-${p.id}`}
                    class={`project-pane ${i === 0 ? '' : 'hidden'}`}
                >
                    <div class="flex flex-wrap justify-between items-start gap-4 mb-8 pb-6 border-b border-slate-300 dark:border-slate-800/50">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                <h2 class="text-4xl font-black text-slate-800 dark:text-white">{p.title}</h2>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                {p.stack.map((s: any) => (
                                    <span class="px-2.5 py-1 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 text-[10px] font-mono rounded hover:bg-emerald-500/20 hover:border-emerald-500/50 transition-all duration-200 cursor-default">
                                        {s}
                                    </span>
                                ))}
                            </div>
                        </div>
                        <a 
                            href={p.links.github}
                            target="_blank"
                            class="px-4 py-2 border border-emerald-500 text-emerald-500 hover:bg-emerald-500 hover:text-black font-bold text-[10px] font-mono transition-all duration-200 hover:shadow-lg hover:shadow-emerald-500/30 hover:scale-105 active:scale-95 rounded"
                        >
                            <span class="flex items-center gap-2">
                                <span>&#9889;</span>
                                <span>FETCH ORIGIN</span>
                            </span>
                        </a>
                    </div>

                    <div class="mb-16">
                        <ul class="space-y-2">
                            {projectDocs?.[p.id]?.map((item: string) => (
                                <li class="flex items-start gap-3 text-slate-700 dark:text-slate-300 font-mono text-sm">
                                    <span class="text-emerald-500 mt-1">$</span>
                                    <span class="flex-1" set:html={item} />
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div class="absolute bottom-6 left-8 right-8 flex justify-between border-t border-slate-300 dark:border-slate-800/50 pt-4 font-mono text-[9px] text-slate-500 dark:text-slate-600">
                        <div class="flex items-center gap-4">
                            <span>&#128193; PATH: ~/projects/{p.id}</span>
                            <span class="text-slate-400 dark:text-slate-700">|</span>
                            <span>&#128274; MODE: read_only</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-emerald-600">ACTIVE</span>
                        </div>
                    </div>
                </div>
            ))}
            </div>
        </div>
    </div>
</Layout>

<style>
  .project-pane {
    animation: fadeIn 0.4s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>

<script>
  const tabs = document.querySelectorAll('.project-tab');
  const panes = document.querySelectorAll('.project-pane');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-target');
      
      // Update UI Tabs
      tabs.forEach(t => t.classList.remove('bg-emerald-500/10', 'text-emerald-400', 'border-l-2', 'border-emerald-500'));
      tab.classList.add('bg-emerald-500/10', 'text-emerald-400', 'border-l-2', 'border-emerald-500');

      // Update Panes
      panes.forEach(p => {
        p.classList.add('hidden');
        if (p.id === `content-${target}`) {
          p.classList.remove('hidden');
          // Trigger reflow for animation
          void (p as HTMLElement).offsetWidth;
        }
      });
    });
  });

  // Default selection
  if (tabs[0]) (tabs[0] as HTMLElement).click();
</script>